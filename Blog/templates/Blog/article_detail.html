{% extends 'Blog/base.html' %}

{% load mptt_tags %}
{% load corkran_tags %}

{% block title %}"{{ article.title }}"{% endblock %}

<!-- Feature image -->
{% block feature %}
<div class="feature unselectable" style="background-image: url('{% if article.thumbnail %} {{ article.thumbnail.url }} {% else %} /media/defaults/feature.jpg {% endif %}');">
	<div class="overlay">{{ article.title|truncatechars:40 }}</div>
</div>
{% endblock %}

{% block content %}

{% if user == article.author %}
<!-- Article edit buttons -->
<div class="dual-option-container closer-below">
	<a href="{% url 'edit-article' article.id %}" class="button">Edit</a>
	<a href="{% url 'delete-article' article.id %}" class="danger button">Delete</a>
</div>
{% endif %}


<!-- Media buttons -->
<div class="media-btn-container closer-below">
	<!-- Twitter -->
	<a href='https://twitter.com/share?url={{request.build_absolute_uri}}&text="{{article.title}}" by {{article.author}}'
		target="_blank" class="unformatted share-btn twitter">
		<div class="button">
			<i class="fab fa-twitter"></i>
		</div>
	</a>

	<!-- Facebook -->
	<a href="https://www.facebook.com/sharer/sharer.php?u={{request.build_absolute_uri}}" target="_blank"
		class="unformatted share-btn facebook">
		<div class="button">
			<i class="fab fa-facebook-f"></i>
		</div>
	</a>

	<!-- Email -->
	<a href="mailto:?subject={{article.title}}&body={{article.title}} - From the Corkran blog. ({{request.build_absolute_uri}})"
		target="_blank" class="unformatted share-btn email">
		<div class="button">
			<i class="fas fa-envelope"></i>
		</div>
	</a>
</div>


<!-- Post navigation -->
<div class="article-navigation-btn-container closer-below">
	<!-- Next post -->
	<a href="{% previous_article_link article %}" class="button prev-post">
		<i class="fas fa-arrow-circle-left"></i>&nbsp;&nbsp;{% previous_article_title article %}
	</a>

	<!-- Previous post -->
	<a href="{% next_article_link article %}" class="button next-post">
		<i class="fas fa-arrow-circle-right"></i>&nbsp;&nbsp;<bdi>{% next_article_title article %}</bdi>
	</a>
</div>


<!-- Article -->
<div class="article main-article card">
	<!-- Header -->
	<div class="header">
		<!-- Title -->
		<div class="heading">{{ article.title }}</div>
		<!-- Date and author -->
		<span class="subheading">
			{{ article.date|date:"F jS, Y, g:i a e" }} - By
			<a href="{% url 'author-sorted-articles' article.author %}"
				title="Articles by {{ article.author.username }}">
				{{ article.author.username }}
			</a>
		</span>
	</div>
	
	<!-- Content -->
	{{ article.content|urlizetrunc:40|linebreaks }}
</div>


<!-- Tags box container -->
<fieldset class="compact card">
	<!-- Heading -->
	<legend class="heading">Tags</legend>

	<!-- Tags box -->
	<div class="list-box">
		{% for tag in article.tags.all %}
		<a href="{% url 'tag-sorted-articles' tag %}" class="clickable tag">{{ tag }}</a>
		{% endfor %}
	</div>
</fieldset>


<!-- Comments container -->
<fieldset class="comments card" id="comments">
	<!-- HEADING -->
	<legend class="heading">Comments ({{article.comment_set.count}})</legend>

	{% if article.comment_set.count > 0 %}
	<!-- Comment tree -->
	<ul>
		{% recursetree article.comment_set.all %}
		<li>
			<!-- Comment -->
			<div class="comment" id="{{ node.id }}">
				<!-- Author and date -->
				<div class="info-container">
					<a href="{% url 'author-sorted-articles' node.author %}"
						title="Articles by {{ article.author.username }}">{{ node.author }}</a>
					<span class="date">- {{ node.date }}</span>
				</div>

				<!-- Content -->
				<div>{{ node.content|urlizetrunc:30 }}</div>

				<!-- Edit comment -->
				<div class="edit editor">
					<form method="post" autocomplete="off">{% csrf_token %}
						<!-- Textarea -->
						<textarea name="content" rows="2" required>{{ node.content }}</textarea>

						<!-- Scroll position and parent id -->
						<input type="hidden" name="id" value="{{ node.id }}">
						<input type="hidden" name="scroll_pos" value="{{ node.id }}">

						<!-- Submit button -->
						<button class="small button" type="submit" name="edit">Edit</button>
					</form>
				</div>

				{% if user.is_authenticated %}
				<!-- Comment buttons -->
				<div class="comment-btn-container">
					<!-- Reply -->
					<div class="small button reply toggle-btn">Reply</div>
					{% if user == article.author or user == node.author %}
					{% if user == node.author %}
					<!-- Edit -->
					<div class="small button edit toggle-btn">Edit</div>
					{% endif %}
					<!-- Delete -->
					<a href="{% url 'delete-comment' node.id %}" class="small danger button">Delete</a>
					{% endif %}
				</div>
				{% endif %}

				<!-- Reply to comment -->
				<div class="reply editor">
					<form method="post" autocomplete="off">{% csrf_token %}
						<!-- Textarea -->
						<textarea name="content" rows="2" placeholder='Reply to: "{{ node.content|truncatechars:25 }}"' required></textarea>

						<!-- Scroll position and parent id -->
						<input type="hidden" name="parent_id" value="{{ node.id }}">
						<input type="hidden" name="scroll_pos" value="{{ node.id }}">

						<!-- Submit button -->
						<button class="small button" type="submit">Post</button>
					</form>
				</div>
			</div>

			{% if not node.is_leaf_node %}
			<ul class="children">
				{{ children }}
			</ul>
			{% endif %}
		</li>
		{% endrecursetree %}
	</ul>
	{% else %}
	<!-- No comments message -->
	<div class="subheading">No comments, yet.</div>
	{% endif %}

	{% if user.is_authenticated %}
	<!-- New comment -->
	<div class="new-comment-form">
		<form method="post">{% csrf_token %}
			<!-- Textarea -->
			<textarea name="content" rows="4" required autocomplete="off" placeholder="New comment..."></textarea>

			<!-- Scroll position -->
			<input type="hidden" name="scroll_pos" value="comments">

			<!-- Submit button -->
			<div class="submit-btn-container">
				<button class="button" type="submit">Comment</button>
			</div>
		</form>
	</div>
	{% endif %}
</fieldset>


<!-- Scroll to top button -->
<div class="clickable floating-btn scroll-top-btn" onclick="scrollToTop()" title="Back to Top">
	<i class="fas fa-angle-double-up"></i>
</div>

{% endblock %}