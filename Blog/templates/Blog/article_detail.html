{% extends 'Blog/base.html' %}

{% load mptt_tags %}

{% block title %}"{{ article.title }}" by {{ article.author.username }}{% endblock %}
{% block description %}{{ article.content|truncatechars:300 }}{% endblock %}

{% block meta_tags %}
<!-- Basic article meta tags -->
<meta name="author" content="{{ article.author.username }}">
<meta name="keywords" content="{{ article.tags.all|join:','}}">

<!-- OG article meta tags -->
<meta property="og:type" content="article">
<meta property="og:title" content="{{ article.title }}">
<meta property="og:article:author" content="{{ article.author.username }}">
<meta property="og:description" content="{{ article.content|truncatechars:300 }}">
<meta property="og:image" content="https://ik.imagekit.io/f92sz8hl8b{% if article.thumbnail %}{{ article.thumbnail.url }}{% else %}/media/defaults/feature.jpg{% endif %}?tr=w-1200,h-600,fo-auto">

<!-- Twitter article meta tags -->
<meta name="twitter:card" content="summary_large_image">
{% endblock %}

{% block feature %}
{% if article.thumbnail %}	

<!-- Feature image -->
<div 
	data-href="https://ik.imagekit.io/f92sz8hl8b/{{ article.thumbnail.url }}" 
	data-srcset="
		https://ik.imagekit.io/f92sz8hl8b{{ article.thumbnail.url }}?tr=w-1650,h-550,fo-auto 3000w, 
		https://ik.imagekit.io/f92sz8hl8b{{ article.thumbnail.url }}?tr=w-1350,h-450,fo-auto 1500w,
		https://ik.imagekit.io/f92sz8hl8b{{ article.thumbnail.url }}?tr=w-900,h-300,fo-auto 1000w,
		https://ik.imagekit.io/f92sz8hl8b{{ article.thumbnail.url }}?tr=w-750,h-250,fo-auto 600w"  
	data-sizes="100vw"
	class="progressive replace feature image-container unselectable darken-overlay">

	<!-- Blurred loader image -->
	<img src="https://ik.imagekit.io/f92sz8hl8b/{{ article.thumbnail.url }}?tr=w-300,h-100,fo-auto" class="preview">

	<!-- Overlay -->
	<div class="cutout-overlay">
		<div data-vertical-truncator="3">{{ article.title }}</div>
		<div class="right-align-text feature-caption">By {{ article.author.username }}</div>
	</div>

	<!-- Image attribution -->
	<div class="caption-overlay">{{ article.attribution|urlizetrunc:20 }}</div>
</div>

{% endif %}
{% endblock %}


{% block content %}

{% if user == article.author %}
<!-- Article edit buttons -->
<div class="nowrap list-box split-items compact-spacing closer-below">
	<a href="{% url 'delete-article' article.id %}" class="small danger button"><i class="fas fa-trash-alt"></i> Delete</a>
	<a href="{% url 'edit-article' article.id %}" class="button small split-item">Edit <i class="fas fa-edit"></i></a>
</div>
{% endif %}


{% if request.user.is_superuser %} 
<!-- Feature article -->
<div class="closer-below word-card card">
	<form method="post">{% csrf_token %}
		<div>
			{{ feature_form.featured }}
			<label for="id_featured">Feature</label>
			<input type="hidden" name="feature">
		</div>
	</form>
</div>
{% endif %}


<!-- Article controls -->
<div class="normal-spacing nowrap list-box split-items closer-below" id="article_controls">

	<!-- Social media share buttons -->
	<div class="compact dropdown">
		<!-- Dropdown button -->
		<div class="small button dropdown-label">
			<i class="fas fa-share-alt"></i>
		</div>

		<!-- Dropdown -->
		<div class="dropdown-content">
			<div class="nowrap list-box compact-spacing">
				<!-- Twitter -->
				<a href='https://twitter.com/share?url={{request.build_absolute_uri}}&text="{{article.title}}" by {{article.author}}'
					target="_blank" class="share-btn twitter small button" title="Share on Twitter">
					<i class="fab fa-twitter"></i>
				</a>
				
				<!-- Facebook -->
				<a href="https://www.facebook.com/sharer/sharer.php?u={{request.build_absolute_uri}}" target="_blank"
					class="share-btn facebook small button" title="Share on Facebook">
					<i class="fab fa-facebook-f"></i>
				</a>
				
				<!-- Email -->
				<a href="mailto:?subject={{article.title}}&body={{article.title}} - From the Corkran blog. ({{request.build_absolute_uri}})"
					target="_blank" class="share-btn email small button" title="Share by email">
					<i class="fas fa-envelope"></i>
				</a>
			</div>
		</div>
	</div>

	<!-- Random article -->
	<a href="{{ random_article_url }}" class="small button" title="Random article">
		<i class="fas fa-random"></i>
	</a>

	<!-- Subscribe or unsubscribe to author -->
	<form method="post">{% csrf_token %}
		<button class="small button" type="submit" name="subscribe" title="{% if subscribed %}Unsubscribe from {{ article.author.username }}{% else %}Subscribe to {{ article.author.username }}{% endif %}">
			{% if subscribed %}
			<i class="fas fa-bell"></i>
			{% else %}
			<i class="far fa-bell"></i>
			{% endif %}
			&nbsp;{{ article.author.subscribed.all|length }}
		</button>
	</form>

	<!-- Add or remove article from user library -->
	<form method="post" class="split-item">{% csrf_token %}
		<button class="small button" type="submit" name="library" title="{% if article_in_library %}Remove article from library{% else %}Add article to library{% endif %}">
			{% if article_in_library %}
			<i class="fas fa-bookmark"></i>
			{% else %}
			<i class="far fa-bookmark"></i>
			{% endif %}
			&nbsp;{{ article.libraries.all|length }}
		</button>
	</form>

	<!-- Zen mode -->
	<div class="small button" onclick="toggleZenMode();" title="Zen mode">
		<i class="fas fa-coffee"></i>
	</div>
	
	<!-- Go to comments -->
	<a href="#comments" class="small button" title="Comments">
		<i class="fas fa-comments"></i>
	</a>
</div>


<!-- Post navigation -->
<div class="list-box nowrap split-items normal-spacing closer-below">
	<!-- Previous post -->
	<a href="{{ previous_article.get_absolute_url }}" class="button single-line-text" title="Newer">
		<i class="fas fa-arrow-circle-left"></i>&nbsp;&nbsp;{{ previous_article.title }}
	</a>
	
	<!-- Next post -->
	<a href="{{ next_article.get_absolute_url }}" class="button split-item single-line-text" id="next_post" title="Older">
		<i class="fas fa-arrow-circle-right"></i>&nbsp;&nbsp;<bdi>{{ next_article.title }}</bdi>
	</a>
</div>


<!-- Article -->
<div class="article main-article card">
	<!-- Header -->
	<div class="header vertically-space-items">
		{% if categories %}
		<!-- Categories -->
		<div class="small closer-below">
			<span class="bold">{{ categories.parent }}</span>
			<span class="grey">
				-{% for category in categories.subcategories %}
				{{ category.name }}{% if not forloop.last %}, {% endif %}
				{% endfor %}
			</span>
		</div>
		{% endif %}

		<!-- Title -->
		<div class="heading closer-below">{{ article.title }}</div>

		<!-- Date and author -->
		<div class="subheading">
			{{ article.date|date:"F jS, Y, g:i a e" }} - By
			<a href="{% url 'author-sorted-articles' article.author %}"
				title="Articles by {{ article.author.username }}">
				{{ article.author.username }}
			</a>
		</div>
	</div>
	
	<div class="vertically-space-items">
		<!-- Content -->
		<div class="content">{{ article.content|urlizetrunc:40|linebreaks }}</div>
		
		<!-- Tags box -->
		<div class="list-box compact-spacing">
			{% for tag in article.tags.all %}
			<a href="{% url 'tag-sorted-articles' tag %}" class="unselectable clickable single-line-text tag">
				{{ tag }}
			</a>
			{% endfor %}
		</div>
	</div>
</div>


<!-- Zen mode article -->
<div id="zen_mode">
	<!-- Close button -->
	<i class="far fa-times-circle clickable close-btn" onclick="toggleZenMode();"></i>
	
	<!-- Article -->
	<div class="content">
		<div class="vertically-space-items">
			<div>
				<!-- Header -->
				<div class="header">
					<div class="heading">{{ article.title }}</div>
					<div class="subheading">By {{ article.author.username }}</div>
				</div>

				<!-- Article content -->
				{{ article.content|linebreaks|urlizetrunc:40 }}
			</div>

			<!-- Go to comments button -->
			<a href="#comments" class="button" onclick="toggleZenMode();">
				Comments&nbsp;&nbsp;<i class="fas fa-comments"></i>
			</a>
		</div>
	</div>
</div>


<!-- Article suggestions list -->
<div class="unselectable list-box compact-spacing">
	{% for article in similar_articles %}
	<div class="article-suggestion">
		<!-- Article thumbnail -->
		<div 
			data-href="https://ik.imagekit.io/f92sz8hl8b/{{ article.thumbnail.url }}" 
			data-srcset="
				https://ik.imagekit.io/f92sz8hl8b/{{ article.thumbnail.url }}?tr=w-1500,h-1000,fo-auto 3000w, 
				https://ik.imagekit.io/f92sz8hl8b/{{ article.thumbnail.url }}?tr=w-900,h-600,fo-auto 1500w,
				https://ik.imagekit.io/f92sz8hl8b/{{ article.thumbnail.url }}?tr=w-840,h-560,fo-auto 1000w,
				https://ik.imagekit.io/f92sz8hl8b/{{ article.thumbnail.url }}?tr=w-570,h-380,fo-auto 600w"	  
			data-sizes="100vw" class="progressive replace article-suggestion-thumbnail darken-overlay image-container">

			<!-- Blurred loader image -->
			<img src="https://ik.imagekit.io/f92sz8hl8b/{{ article.thumbnail.url }}?tr=w-300,h-200,fo-auto" class="preview">
		</div>

		<!-- Title overlay -->
		<a href="{{ article.get_absolute_url }}">
			<div class="cutout-overlay" data-vertical-truncator="4">{{ article.title }}</div>
		</a>
	</div>
	{% empty %}
	<!-- No similarly tagged articles -->
	<div class="word-card card special">
		<span class="montserrat">
			A unique article. Niche? Peerless? All we know is, nothing is tagged similarly to it.
		</span>
	</div>
	{% endfor %}
</div>


<!-- Comments box anchor -->
<div class="anchor" id="comments"></div>

<!-- Login portal -->
{% if not user.is_authenticated %}
<div class="special word-card card">
	<div class="montserrat text">
		Join the conversation - <a href="{% url 'login' %}?next={{ article.get_absolute_url }}#comments">Login</a> to comment.
	</div>
</div>
{% endif %}

<!-- Comments container -->
<fieldset class="card" id="comments_container">
	<!-- New comment -->
	{% if user.is_authenticated %}
	<form method="post" class="vertically-space-items confirm-leave">{% csrf_token %}
		<!-- Textarea -->
		<textarea name="content" rows="4" required autocomplete="off" placeholder="New comment..." class="closer-below"></textarea>

		<!-- Submit button -->
		<div class="right-align-text">
			<button class="button" type="submit" name="comment">Comment</button>
		</div>
	</form>

	<!-- Horizontal line -->
	<div class="horizontal-divider"></div>

	{% endif %}

	<!-- Heading -->
	<legend class="heading">Comments</legend>

	{% if article.comment_set.count > 0 %}
	<!-- Comment tree -->
	<ul>
		{% recursetree article.comment_set.all %}
		<li>
			<!-- Comment anchor -->
			<div class="anchor" id="{{ node.id }}"></div>

			<!-- Comment -->
			<div class="comment">
				<!-- Author and date -->
				<div class="info-container single-line-text">
					<a href="{% url 'author-sorted-articles' node.author %}" title="Articles by {{ node.author }}">{{ node.author }}</a>
					<span class="montserrat text grey"> ~ {{ node.date|date:"F jS, Y | g:i a e" }}</span>
				</div>

				<!-- Content -->
				<div class="content text preserve-linebreaks">{{ node.content|urlizetrunc:30 }}</div>

				<!-- Edit comment -->
				<div class="edit editor">
					<form class="confirm-leave" method="post" autocomplete="off">{% csrf_token %}
						<!-- Textarea -->
						<textarea name="content" rows="2" required>{{ node.content }}</textarea>

						<!-- Parent id -->
						<input type="hidden" name="id" value="{{ node.id }}">

						<!-- Submit button -->
						<div class="right-align-text">
							<button class="minimal no-border button" type="submit" name="edit">Edit</button>
						</div>
					</form>
				</div>

				{% if user.is_authenticated %}
				<!-- Comment buttons -->
				<div class="comment-btn-container">
					<!-- Reply -->
					<div class="minimal no-border button reply toggle-btn">Reply</div>
					{% if user == article.author or user == node.author %}
					{% if user == node.author %}
					<!-- Edit -->
					<div class="minimal no-border button edit toggle-btn">Edit</div>
					{% endif %}
					<!-- Delete -->
					<a href="{% url 'delete-comment' node.id %}" class="minimal no-border danger button">Delete</a>
					{% endif %}
				</div>
				{% endif %}

				<!-- Reply to comment -->
				<div class="reply editor">
					<form class="confirm-leave" method="post" autocomplete="off">{% csrf_token %}
						<!-- Textarea -->
						<textarea name="content" rows="2" placeholder='Reply to: "{{ node.content|truncatechars:25 }}"' required></textarea>

						<!-- Parent id -->
						<input type="hidden" name="parent_id" value="{{ node.id }}">

						<!-- Submit button -->
						<div class="right-align-text">
							<button class="minimal no-border button" type="submit" name="reply">Post</button>
						</div>
					</form>
				</div>
			</div>

			{% if not node.is_leaf_node %}
			<ul class="children">
				{{ children }}
			</ul>
			{% endif %}
		</li>
		{% endrecursetree %}
	</ul>
	{% else %}
	<!-- No comments message -->
	<div class="word-card card special">
		<span class="montserrat">
			No comments. Maybe it's new. Or confusing.
		</span>
	</div>
	{% endif %}
</fieldset>

{% endblock %}


{% block floating-button %}
<!-- Scroll to top button -->
<a href="#top" class="floating-btn scroll-top-btn" title="Back to Top">
	<i class="fas fa-chevron-up"></i>
</a>
{% endblock %}